<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Secure Chat with JWT + WebSocket</title>
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	<link rel="icon" href="data:,">
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 20px;
		}

		#messages {
			border: 1px solid #ccc;
			padding: 10px;
			height: 300px;
			overflow: auto;
			background: #fafafa;
		}

		input,
		button {
			padding: 5px;
			margin: 5px;
		}
	</style>
</head>

<body>
	<h2>Spring Boot Secure Chat (JWT + WebSocket)</h2>

	<div id="loginDiv">
		<h3>Login</h3>
		Username: <input id="username" />
		Password: <input id="password" type="password" />
		<button onclick="login()">Login</button>
	</div>

	<div id="chatDiv" style="display:none;">
		<p>Welcome, <span id="userLabel"></span>!</p>
		<button id="connectBtn">Connect</button>
		<button id="disconnectBtn" disabled>Disconnect</button>
		<div id="messages"></div>
		<form id="msgForm" onsubmit="sendMessage(event)">
			<input id="message" autocomplete="off" placeholder="Type a message" style="width:70%">
			<button id="sendBtn" disabled>Send</button>
		</form>
	</div>

	<script>
		let stompClient = null;
		let token = null;

		/* -------------------------------------
		   STEP 1: LOGIN
		-------------------------------------- */
		async function login() {
			const username = document.getElementById("username").value;
			const password = document.getElementById("password").value;

			const res = await fetch("http://localhost:8088/api/auth/login", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ username, password })
			});

			if (!res.ok) { alert("Login failed!"); return; }

			const data = await res.json();
			token = data.token;

			document.getElementById("loginDiv").style.display = "none";
			document.getElementById("chatDiv").style.display = "block";
			document.getElementById("userLabel").textContent = username;

			// Load old messages from DB
			await loadHistory();

			alert("Login successful! Now connect to chat.");
		}

		/* -------------------------------------
		   STEP 2: LOAD CHAT HISTORY
		-------------------------------------- */
		async function loadHistory() {
			try {
				const res = await fetch("http://localhost:8088/api/chat/history");
				const msgs = await res.json();

				msgs.forEach(m => {
					showMessage(m.sender + ": " + m.text);
				});
			} catch (e) {
				console.error("Error loading history:", e);
			}
		}

		/* -------------------------------------
		   STEP 3: CONNECT WEBSOCKET
		-------------------------------------- */
		document.getElementById('connectBtn').addEventListener('click', function () {
			const socket = new SockJS('/ws');
			stompClient = Stomp.over(socket);

			stompClient.connect(
				{ Authorization: "Bearer " + token }, // send JWT
				function (frame) {
					console.log('Connected: ' + frame);

					document.getElementById('connectBtn').disabled = true;
					document.getElementById('disconnectBtn').disabled = false;
					document.getElementById('sendBtn').disabled = false;

					// Subscribe to public chat topic
					stompClient.subscribe('/topic/greetings', function (message) {
						const body = JSON.parse(message.body);
						showMessage(body.sender + ": " + body.text);
					});
				},
				function (error) {
					alert("Connection error: " + error);
				}
			);
		});

		/* -------------------------------------
		   STEP 4: DISCONNECT
		-------------------------------------- */
		document.getElementById('disconnectBtn').addEventListener('click', function () {
			if (stompClient) {
				stompClient.disconnect();
				console.log('Disconnected');
				document.getElementById('connectBtn').disabled = false;
				document.getElementById('disconnectBtn').disabled = true;
				document.getElementById('sendBtn').disabled = true;
			}
		});

		/* -------------------------------------
		   STEP 5: SEND MESSAGE
		-------------------------------------- */
		function sendMessage(event) {
			event.preventDefault();
			const text = document.getElementById('message').value;

			stompClient.send('/app/hello', {}, JSON.stringify({
				sender: document.getElementById("userLabel").innerText,
				text: text,
				time: new Date().toISOString()
			}));

			document.getElementById('message').value = '';
		}

		/* -------------------------------------
		   STEP 6: DISPLAY MESSAGE
		-------------------------------------- */
		function showMessage(msg) {
			const div = document.getElementById('messages');
			const p = document.createElement('p');
			p.textContent = msg;
			div.appendChild(p);
			div.scrollTop = div.scrollHeight;
		}
	</script>

</body>
</html>
